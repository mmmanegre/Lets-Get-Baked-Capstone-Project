<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recipe</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <header>
        <div class="head">
            <img src="images/logo2.png" class="logo">

            <nav>
                <a href="index.html">Home</a>
                <a href="profile.html">Profile</a>
                <a href="savedrecipes.html">My Recipes</a>
                <a href="shop.html">Shopping List</a>
            </nav>
        </div>
    </header>

    <main>
        <div id="recipe-container"></div>
        <div class="scaling-box">
            <h3>Scale Recipe</h3>
            <label>Servings:</label>
            <input type="number" id="servingScaler" min="1" value="">
            <button id="applyScaleBtn">Apply</button>
        </div>

        <section>
            Like this recipe? <button id="savebtn">‚ù§Ô∏è</button>
            Add to Cart <button id="cartbtn" class="cart-btn">üõí</button>
        </section>
    </main>

    <footer>
        <p>Created by Michelle, Kaylee, and Ellie</p>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="script.js"></script>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
    "https://vbbxceqbzcfieymlcksu.supabase.co",
    "YOUR_PUBLIC_ANON_KEY"
);

// -----------------------------
// LOCAL CART HELPERS (works when logged out)
// -----------------------------
function getLocalCart() {
    return JSON.parse(localStorage.getItem("cartIngredients")) || [];
}

function saveLocalCart(cart) {
    localStorage.setItem("cartIngredients", JSON.stringify(cart));
}

function addIngredientsToLocalCart(ingredients) {
    const cart = getLocalCart();
    cart.push(...ingredients);
    saveLocalCart(cart);
}

// -----------------------------
// SYNC local cart ‚Üí Supabase when user logs in
// -----------------------------
async function syncLocalCart(userId) {
    const local = getLocalCart();
    if (local.length === 0) return;

    const rows = local.map(item => ({
        user_id: userId,
        ingredient: item
    }));

    await supabase.from("shopping_list").insert(rows);
    localStorage.removeItem("cartIngredients");
}

// Listen to login event
supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === "SIGNED_IN") {
        await syncLocalCart(session.user.id);
    }
});

// -----------------------------
// SAVE INGREDIENTS (cart button)
// -----------------------------
async function saveIngredients() {
    // Get user
    const { data: userData } = await supabase.auth.getUser();
    const user = userData?.user;

    // Collect ingredients from page
    const ingredientElements = document.querySelectorAll(".ingredient-item");
    const ingredients = Array.from(ingredientElements).map(li => li.textContent.trim());

    if (ingredients.length === 0) {
        alert("No ingredients found.");
        return;
    }

    // If NOT LOGGED IN ‚Üí save locally
    if (!user) {
        addIngredientsToLocalCart(ingredients);
        alert("Ingredients saved! Navigate to your shopping list.");
        return;
    }

    // LOGGED IN ‚Üí save to database
    const rows = ingredients.map(item => ({
        user_id: user.id,
        ingredient: item
    }));

    const { error } = await supabase.from("shopping_list").insert(rows);

    if (error) {
        console.error("Insert error:", error);
        alert("Error saving ingredients.");
        return;
    }

    alert("Ingredients added to your shopping list! üõí");
}

// -----------------------------
// BUTTON SETUP
// -----------------------------
document.addEventListener("DOMContentLoaded", () => {
    const cartButton = document.getElementById("cartbtn");

    if (!cartButton) {
        console.error("‚ùå No button with id='cartbtn' found.");
        return;
    }

    cartButton.addEventListener("click", saveIngredients);
});
</script>


    <!-- Toast notification -->
    <div id="toast">Recipe saved! ‚ù§Ô∏è</div>

</body>
</html>
