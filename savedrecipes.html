<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Recipes</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <header>
        <div class="head">
            <img src="images/logo2.png" class="logo">

            <nav>
                <a href="index.html">Home</a>
                <a href="profile.html">Profile</a>
                <a href="savedrecipes.html">My Recipes</a>
                <a href="shop.html">Shopping List</a>
            </nav>
        </div>
    </header>

    <main>
        <h2>Saved Recipes</h2>
        <div id="saved-list"></div>
    </main>

        <!-- Toast Notification -->
    <div id="toast"></div>
    
    <!-- Confirmation Popup -->
    <div id="confirm-popup" class="confirm hidden">
        <div class="confirm-box">
            <p id="confirm-message"></p>
            <div class="confirm-buttons">
                <button id="confirm-yes" class="yes">Yes</button>
                <button id="confirm-no" class="no">No</button>
            </div>
        </div>
    </div>



    <footer>
        <p>Created by Michelle, Kaylee, and Ellie</p>
    </footer>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://vbbxceqbzcfieymlcksu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiYnhjZXFiemNmaWV5bWxja3N1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2ODYyMDYsImV4cCI6MjA3NzI2MjIwNn0.KO4SvADxHLPW3IRPU1t_buQcY_Zim-p2G-kcK2v2Akg";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const savedList = document.getElementById("saved-list");
let lastRemoved = null;

// ---------------------
// Toast
// ---------------------
function showToast(message, undo = false) {
  const toast = document.getElementById("toast");
  toast.innerHTML = message + (undo ? ' <button id="undo-btn">Undo</button>' : '');
  toast.classList.add("show");

  if (undo) {
    document.getElementById("undo-btn").onclick = undoRemove;
  }

  setTimeout(() => toast.classList.remove("show"), 3000);
}

// ---------------------
// Confirm Popup
// ---------------------
function showConfirm(message, confirmCallback) {
  const popup = document.getElementById("confirm-popup");
  document.getElementById("confirm-message").textContent = message;
  popup.classList.remove("hidden");

  document.getElementById("confirm-yes").onclick = () => {
    popup.classList.add("hidden");
    confirmCallback();
  };

  document.getElementById("confirm-no").onclick = () =>
    popup.classList.add("hidden");
}

// ---------------------
// Load Saved Recipes
// ---------------------
async function loadSavedRecipes() {
  const stored = localStorage.getItem("loggedInUser");
  if (!stored) return;

  const { username } = JSON.parse(stored);

  const { data, error } = await supabase
    .from("savedrecipes")
    .select(`
      recipeid,
      recipes (
        name
      )
    `)
    .eq("userid", username); // ✅ FIX

  savedList.innerHTML = "";

  if (error) {
    console.error(error);
    savedList.innerHTML = "<p>Error loading recipes.</p>";
    return;
  }

  if (!data || data.length === 0) {
    savedList.innerHTML = "<p>No saved recipes yet.</p>";
    return;
  }

  data.forEach(row => {
    const wrapper = document.createElement("div");
    wrapper.style.marginBottom = "10px";

    const link = document.createElement("a");
    link.href = `recipe.html?id=${row.recipeid}`;
    link.textContent = row.recipes?.name || "Unknown recipe";
    link.style.marginRight = "10px";

    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Remove ❌";
    removeBtn.onclick = () =>
      showConfirm(
        `Remove "${link.textContent}"?`,
        () => removeRecipe(username, row.recipeid, link.textContent)
      );

    wrapper.appendChild(link);
    wrapper.appendChild(removeBtn);
    savedList.appendChild(wrapper);
  });
}

// ---------------------
// Remove Recipe
// ---------------------
async function removeRecipe(username, recipeid, name) {
  await supabase
    .from("savedrecipes")
    .delete()
    .eq("userid", username)   // ✅ FIX
    .eq("recipeid", recipeid);

  lastRemoved = { userid: username, recipeid };
  loadSavedRecipes();
  showToast(`Removed "${name}"`, true);
}

// ---------------------
// Undo Remove
// ---------------------
async function undoRemove() {
  if (!lastRemoved) return;

  await supabase
    .from("savedrecipes")
    .insert(lastRemoved);

  lastRemoved = null;
  loadSavedRecipes();
  showToast("Undo complete ✔️");
}

// ---------------------
loadSavedRecipes();
</script>

    

</body>
</html>
